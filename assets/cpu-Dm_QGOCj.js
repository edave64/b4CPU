var m=Object.defineProperty;var _=(s,e,t)=>e in s?m(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var g=(s,e,t)=>_(s,typeof e!="symbol"?e+"":e,t);import{w as f,r,c as u,O as h}from"./index-rMVkXsJe.js";function O(s){return{instructions:s.instructions.map(e=>({name:e.name,gates:new Set(e.gates)})),timingMasks:{[l.Fetch]:new Set(s.timingMasks.fetch),[l.Decode]:new Set(s.timingMasks.decode),[l.Read]:new Set(s.timingMasks.read),[l.Execute]:new Set(s.timingMasks.exec),[l.Write]:new Set(s.timingMasks.write)}}}var l=(s=>(s[s.Fetch=0]="Fetch",s[s.Decode=1]="Decode",s[s.Read=2]="Read",s[s.Execute=3]="Execute",s[s.Write=4]="Write",s))(l||{});const n=class n{constructor(e){this.decoderState=e,globalThis.cpu=this,f(()=>this.instructionsOp[this.pc.value],()=>{this.stage===1&&(this.decodedStages=this.decodeStages(this.pc.value))}),this.decodedStages=this.decodeStages(this.pc.value)}_stage=r(0);pc=r(0);address=u(()=>this.instructionsAddr[this.pc.value]);regA=r(0);regB=r(0);flagZ=r(!1);flagO=r(!1);_pcJump=u(()=>{const e=this._jmpNot.value,t=this._jmpOverflow.value,a=this._jmpZero.value;if(!t&&!a)return e;const i=(a?this.flagZ.value:!0)&&(t?this.flagO.value:!0);return e?!i:i});_jmpNot=r(!1);_jmpZero=r(!1);_jmpOverflow=r(!1);_regAWrite=r(!1);_regARead=r(!1);_regBWrite=r(!1);_regBRead=r(!1);_ramWrite=r(!1);_ramRead=r(!1);_aluOp1=r(!1);_aluOp2=r(!1);_aluOp=u(()=>(this._aluOp1.value?1:0)+(this._aluOp2.value?2:0));_aluInA=r(0);_aluInB=r(0);_regAOut=r(0);_regBOut=r(0);_aluOut=r(0);_ramOut=r(0);data=u(()=>(this._regARead.value?this._regAOut.value:0)|(this._regBRead.value?this._regBOut.value:0)|(this._aluOp.value?this._aluOut.value:0)|(this._ramRead.value?this._ramOut.value:0)|this.instructionsData[this.pc.value]);aluInA=u(()=>this._aluOp.value===0?this.regA.value:this._aluInA.value);aluInB=u(()=>this._aluOp.value===0?this.regB.value:this._aluInB.value);get pcJump(){return this._pcJump.value}get stage(){return this._stage.value}set stage(e){if(e!==this._stage.value){switch(e){case 0:{const t=this.pcJump?this.address.value:this.pc.value+1&15;this.pc.value=t;break}case 1:this.decodedStages=this.decodeStages(this.pc.value);break}this._stage.value=e}}get jmpNot(){return this._jmpNot.value}get jmpZero(){return this._jmpZero.value}get jmpOverflow(){return this._jmpOverflow.value}get regAWrite(){return this._regAWrite.value}get regARead(){return this._regARead.value}get regBWrite(){return this._regBWrite.value}get regBRead(){return this._regBRead.value}get ramWrite(){return this._ramWrite.value}get ramRead(){return this._ramRead.value}get aluOp(){return this._aluOp.value}ram=h(Array(16).fill(0));instructionsOp=h(Array(16).fill(0));instructionsAddr=h(Array(16).fill(0));instructionsData=h(Array(16).fill(0));execAluOp(){const e=this.aluOp,t=this.regA.value,a=this.regB.value;switch(e){case 1:return t&a;case 2:return t+a;case 3:return t-a}return 0}nextStage(){const e=this.stage,t=n.NextStage[e],a=this.decodedStages[e],i=this.decodedStages[t];for(const c of Object.keys(this.gateMap)){const v=this.gateMap[c];v.value=i.has(c)}const d=i.difference(a);this.processGateActivations(d),this.stage=t}processGateActivations(e){if(e.has("AR")&&(this._regAOut.value=this.regA.value),e.has("BR")&&(this._regBOut.value=this.regB.value),e.has("RR")&&(this._ramOut.value=this.ram[this.address.value]),e.has("AW")&&(this.regA.value=this.data.value),e.has("BW")&&(this.regB.value=this.data.value),e.has("RW")&&(this.ram[this.address.value]=this.data.value),e.has("ALU1")||e.has("ALU2")){const t=this.execAluOp();this._aluInA.value=this.regA.value,this._aluInB.value=this.regB.value,this._aluOut.value=t&15,this.flagZ.value=this._aluOut.value===0,this.flagO.value=t>15||t<0}}step(){do this.nextStage();while(this.stage!==0)}decodedStages;decodeStage(e,t){const a=this.decoderState.instructions[e].gates,i=this.decoderState.timingMasks[t];return a.intersection(i)}saveState(){return{regA:this.regA.value,regB:this.regB.value,pc:this.pc.value,instructionsOp:Array.from(this.instructionsOp),instructionsAddr:Array.from(this.instructionsAddr),instructionsData:Array.from(this.instructionsData),ram:Array.from(this.ram),stage:this.stage,flagZ:this.flagZ.value,flagO:this.flagO.value,aluInA:this._aluInA.value,aluInB:this._aluInB.value,regAOut:this._regAOut.value,regBOut:this._regBOut.value,aluOut:this._aluOut.value,ramOut:this._ramOut.value,decoderState:this.saveDecoder()}}saveDecoder(){return{timingMasks:{fetch:Array.from(this.decoderState.timingMasks[0]),decode:Array.from(this.decoderState.timingMasks[1]),read:Array.from(this.decoderState.timingMasks[2]),exec:Array.from(this.decoderState.timingMasks[3]),write:Array.from(this.decoderState.timingMasks[4])},instructions:this.decoderState.instructions.map(e=>({name:e.name,gates:Array.from(e.gates)}))}}static loadState(e){const t=new n(O(e.decoderState));t.regA.value=e.regA,t.regB.value=e.regB,t.pc.value=e.pc;for(let a=0;a<16;a++)t.instructionsOp[a]=e.instructionsOp[a]??0,t.instructionsAddr[a]=e.instructionsAddr[a]??0,t.instructionsData[a]=e.instructionsData[a]??0,t.ram[a]=e.ram[a]??0;return t.decodedStages=t.decodeStages(t.pc.value),t.stage=e.stage,t.flagZ.value=e.flagZ,t.flagO.value=e.flagO,t._aluInA.value=e.aluInA,t._aluInB.value=e.aluInB,t._regAOut.value=e.regAOut,t._regBOut.value=e.regBOut,t._aluOut.value=e.aluOut,t._ramOut.value=e.ramOut,t}decodeStages(e){const t=this.decoderState.instructions[this.instructionsOp[e]].gates,a=this.decoderState.timingMasks;return{0:t.intersection(a[0]),1:t.intersection(a[1]),2:t.intersection(a[2]),3:t.intersection(a[3]),4:t.intersection(a[4])}}gateMap={JN:this._jmpNot,JZ:this._jmpZero,JO:this._jmpOverflow,RR:this._ramRead,RW:this._ramWrite,AR:this._regARead,AW:this._regAWrite,BR:this._regBRead,BW:this._regBWrite,ALU1:this._aluOp1,ALU2:this._aluOp2}};g(n,"NextStage",{0:1,1:2,2:3,3:4,4:0});let o=n;export{o as C,l as a,O as r};
